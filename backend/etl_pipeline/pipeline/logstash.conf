input {
  file {
    path => "/usr/share/logstash/ingest_json/*.json"  # JSON files in the mounted ingestion folder
    start_position => "beginning"              # Read new files from the beginning
    sincedb_path => "/usr/share/logstash/data/sincedb.txt"  # Persistent file to remember ingestion state
    codec => json                             # Parse each line as a JSON object
    discover_interval => 15
  }
}

filter {
  ruby {
    code => "
      themes = event.get('[V2EnhancedThemes][V2Theme]')
      if themes.is_a?(Array)
        # Check if any theme matches the specified criteria
        match = themes.any? do |t|
          # 1. Exact match for WB_2467_TERRORISM
          t == 'WB_2467_TERRORISM' ||
          # 2. Exact match for WB_2492_COUNTER_TERRORISM
          t == 'WB_2492_COUNTER_TERRORISM' ||
          # 3. Case-insensitive check if the theme *contains* TAX_TERROR
          t =~ /TAX_TERROR/i
        end

        # Cancel the event if none of the themes matched
        event.cancel unless match
      else
        # Optional: Handle the case where themes is not an array (e.g., nil or empty)
        # If no themes are present, it likely means no match, so cancel.
        event.cancel
      end
    "
  }
  # Extract first value from the array
  ruby {
    code => "
        lat = event.get('[V2Locations][LocationLatitude]')
        lon = event.get('[V2Locations][LocationLongitude]')
        
        if lat and lon
          locations = []
          lat.each_with_index do |lat_value, index|
            lon_value = lon[index]
            if lat_value and lon_value
              locations << [lon_value.to_f, lat_value.to_f]
            end
          end
          event.set('location', locations) unless locations.empty?
        end
      "
  }

  # --- Mutate filter for NESTED GkgRecordId.Date ---
  # Check if the nested field exists before attempting conversion
  if [GkgRecordId][Date] {   # <-- Check using nested access
    mutate {
      convert => {
        "[GkgRecordId][Date]" => "string"  # <-- Convert using nested access
      }
      id => "convert_gkg_date_to_string"
    }
  } # End of 'if [GkgRecordId][Date]'

}
output {
  elasticsearch {
    hosts => ["https://es01:9200"]          # Replace <ES_IP> with your Elasticsearch container's IP (e.g., 172.20.0.2)
    index => "gkg"                    # Replace <INDEX_NAME> with your desired index name (e.g., gdelt_test)
    user => "elastic"                        # Replace <ES_USER> with your Elasticsearch username (e.g., elastic)
    password => "changeme"                # Replace <ES_PASSWORD> with your Elasticsearch password
    ssl_certificate_verification => false     # Disable certificate verification (for self-signed certs)

  # Manage the template directly in the config
    manage_template => true
    template_overwrite => true
    template => "/usr/share/logstash/template.json"  # Path to template file
  }
}